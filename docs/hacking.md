# Hacking on IceCap

```
UNDER CONSTRUCTION
```

This repository contains the source of the IceCap Framework and the IceCap
Hypervisor, which is build-system independent, and a Nix-based build system
which encompases not only the core of IceCap, but also tests and benchmarks
which include all additional components necessary for a complete system, such as
Linux kernels and userspaces.

This document covers the most important aspects of developing in this
repository.

If you want to incorporate IceCap into a build system without Nix, see [Building
without Nix](./icecap-without-nix.md).

Throughout this guide, `//` is used to refer to the project root at [../](../).

### Development environment

The easiest way to get started building and hacking on IceCap is with Docker.
If you want to build IceCap without Docker, the only requirement is
[Nix](https://nixos.org/manual/nix/stable/) (version `>= 2.4`).
[../docker](../docker) serves not only as a readily accessible environment, but
also as a reference or starting point for any other development environment for
hacking on IceCap.
[../hack/dev-environment-examples/config.example.nix](../hack/dev-environment-examples/config.example.nix)
for an examples NixOS module which sets up a complete development environment
for IceCap.

Start with the following to run and enter the container:

```
make -C docker/ run && make -C docker/ exec
```

If [./docker/Makefile](./docker/Makefile) detects that you are on Linux, then
this Docker container is effectively stateless.  All of the build system's state
lives in a Docker volume.  Consequentially, you can destroy the container,
modify the Dockerfile, rebuild the image, and re-run it without losing cached
IceCap build artifacts.

### Repository overview

Care has been taken to ensure that the IceCap source code itself is build-system
agnostic. The `//src` directory contains the IceCap source, and `//nix` contains
the Nix-based build system. `//nix` is structured as a single Nix expression,
accessible from `//default.nix`. See `//nix/default.nix` for information on the
structure of this Nix expression.  With one exception which is detailed below,
interacting with the IceCap build system is as simple as making Nix command-line
tool invocations on `//default.nix`.  Aside from `result` symlinks, interacting
with the IceCap build system has no side effects on the working tree.

Interactive exploration using `nix repl` can be a useful tool when combined with
looking at the Nix code itself. You can use tab completion inside the repl to
traverse the expression. Furthermore, the Docker container is equipped with Bash
tab completion for all Nix command-line tools. For example, try `nix-build -A
framework.<tab><tab>`.

The one aspect of the IceCap build system which has side effects on the working
tree is the generation of Cargo-related files in `//src/rust`. For a variety of
reasons, `Cargo.lock` and `Cargo.toml` files are generated by Nix. To enable the
IceCap source to be used by build systems that are not based on Nix, we check in
these generated files alongside the source. See the `update-generated-sources`
target in `//Makefile`. The instances of these files which are checked in
alongside the source are not used by the Nix-based build system.

Checking in these Cargo-related files also allows for a convenient Cargo-based
workflow for rapid iteration on code in `//src/rust`. To use
`//src/rust/Makefile`, first enter a `nix-shell` using `//src/rust/shell.nix`.

The top-level Makefile (`//Makefile`) provides some convenient rules for
building common groups of derivations. It also contains some rules displaying
groups of related build artifacts.

`//hacking` contains miscelanous files related to hacking and maintenance, which
exist outside of the source code and build system. See `//hacking/Makefile` for
entrypoints.

```
TODO
```

<!--

### Leveraging a Nix remote cache

```
TODO
```

### Using local checkouts of dependencies

```
TODO
```

### Modifying `defconfig`s

```
TODO
```

### Working with the Raspberry Pi 4

```
TODO
```

### Infrastructure: CI and caches

```
TODO
```

-->

<!--

TODO
- gdb
- git-icecap-keep
- ...much more

-->
